<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(255, 255, 255, 0.1)",
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="text-slate-200 p-4 md:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow w-full">
        
        <aside class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-2xl p-6 shadow-xl">
                <h2 class="text-xl font-bold mb-4 text-indigo-400 flex items-center gap-2">
                    <i class="fa-solid fa-sliders"></i> Parameters
                </h2>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs text-slate-400 uppercase tracking-wider">Attended</label>
                        <input type="number" id="inputAttended" class="save-input w-full bg-slate-800 border border-slate-600 rounded p-2 mt-1 focus:border-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 uppercase tracking-wider">Total Held</label>
                        <input type="number" id="inputTotal" class="save-input w-full bg-slate-800 border border-slate-600 rounded p-2 mt-1 focus:border-indigo-500 focus:outline-none">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-xs text-slate-400 uppercase tracking-wider">Target Percentage (%)</label>
                    <input type="number" id="inputTarget" value="75" class="save-input w-full bg-slate-800 border border-slate-600 rounded p-2 mt-1 focus:border-indigo-500 focus:outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs text-slate-400 uppercase tracking-wider">Start Date</label>
                        <input type="date" id="startDate" class="save-input w-full bg-slate-800 border border-slate-600 rounded p-2 mt-1 text-sm focus:border-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 uppercase tracking-wider">End Date</label>
                        <input type="date" id="endDate" class="save-input w-full bg-slate-800 border border-slate-600 rounded p-2 mt-1 text-sm focus:border-indigo-500 focus:outline-none">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-xs text-slate-400 uppercase tracking-wider mb-2 block">Classes per Day</label>
                    <div class="grid grid-cols-7 gap-1 text-center">
                        <div><span class="text-[10px] text-slate-500">Mon</span><input type="number" min="0" value="4" class="day-input save-input w-full bg-slate-800 rounded p-1 text-center text-sm" data-day="1"></div>
                        <div><span class="text-[10px] text-slate-500">Tue</span><input type="number" min="0" value="3" class="day-input save-input w-full bg-slate-800 rounded p-1 text-center text-sm" data-day="2"></div>
                        <div><span class="text-[10px] text-slate-500">Wed</span><input type="number" min="0" value="4" class="day-input save-input w-full bg-slate-800 rounded p-1 text-center text-sm" data-day="3"></div>
                        <div><span class="text-[10px] text-slate-500">Thu</span><input type="number" min="0" value="2" class="day-input save-input w-full bg-slate-800 rounded p-1 text-center text-sm" data-day="4"></div>
                        <div><span class="text-[10px] text-slate-500">Fri</span><input type="number" min="0" value="5" class="day-input save-input w-full bg-slate-800 rounded p-1 text-center text-sm" data-day="5"></div>
                        <div><span class="text-[10px] text-slate-500">Sat</span><input type="number" min="0" value="0" class="day-input save-input w-full bg-slate-800 rounded p-1 text-center text-sm" data-day="6"></div>
                        <div><span class="text-[10px] text-slate-500">Sun</span><input type="number" min="0" value="0" class="day-input save-input w-full bg-slate-800 rounded p-1 text-center text-sm" data-day="0"></div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="text-xs text-slate-400 uppercase tracking-wider block mb-1">Exclude Specific Dates</label>
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <span class="text-[10px] text-slate-500 block mb-0.5">Pick Date</span>
                            <input type="date" id="holidayInput" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs focus:border-indigo-500 focus:outline-none">
                        </div>
                        <button onclick="addHoliday()" class="h-[34px] bg-indigo-600 hover:bg-indigo-500 px-3 rounded text-white transition-colors" title="Add Date">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-[10px] text-slate-500 uppercase">Excluded Dates</span>
                            <button onclick="clearHolidays()" class="text-[10px] text-red-400 hover:text-red-300 underline">Clear All</button>
                        </div>
                        <ul id="holidayList" class="max-h-32 overflow-y-auto space-y-1 pr-1"></ul>
                    </div>
                </div>

                <button onclick="calculateAttendance()" class="w-full bg-indigo-500 hover:bg-indigo-400 text-white font-bold py-3 rounded-lg shadow-lg transition-all transform hover:scale-[1.02]">
                    Calculate Projection
                </button>
            </div>
        </aside>

        <main class="lg:col-span-8 space-y-6">
            
            <div id="statusBanner" class="glass-panel rounded-2xl p-6 border-l-8 border-slate-500 hidden transition-all">
                <h1 class="text-2xl font-bold mb-1" id="statusTitle">Ready</h1>
                <p class="text-slate-300 text-lg" id="statusMessage">Enter details.</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                
                <div class="glass-panel p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase mb-1">Current %</div>
                    <div class="text-2xl font-bold text-white" id="statCurrent">0%</div>
                </div>
                
                <div class="glass-panel p-4 rounded-xl text-center bg-emerald-900/20 border-emerald-500/30 border">
                    <div class="text-emerald-400 text-xs uppercase mb-1 font-bold">Safe Bunks</div>
                    <div class="text-3xl font-bold text-emerald-300" id="statBunks">-</div>
                    <div class="text-[10px] text-emerald-500/80 mt-1">Margin of Safety</div>
                </div>

                <div class="glass-panel p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase mb-1">Must Attend</div>
                    <div class="text-2xl font-bold text-indigo-300" id="statNeeded">-</div>
                </div>

                <div class="glass-panel p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase mb-1">Future Classes</div>
                    <div class="text-2xl font-bold text-indigo-300" id="statRemaining">-</div>
                </div>

                <div class="glass-panel p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase mb-1">Max Possible %</div>
                    <div class="text-2xl font-bold text-white" id="statMax">-</div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden flex flex-col h-[500px]">
                <div class="p-4 bg-slate-800/50 border-b border-white/10 flex justify-between items-center">
                    <h3 class="font-bold text-indigo-200"><i class="fa-regular fa-calendar-days mr-2"></i> Project Schedule</h3>
                    <span class="text-xs text-slate-500 italic">Detailed breakdown</span>
                </div>
                <div class="overflow-y-auto flex-1 p-4">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead class="text-slate-400 sticky top-0 bg-slate-900 z-10">
                            <tr>
                                <th class="pb-3 pl-2">Date</th>
                                <th class="pb-3">Day</th>
                                <th class="pb-3 text-center">Classes</th>
                                <th class="pb-3 text-right pr-2">Running Total</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="text-center py-4 text-slate-500">No data yet. Click Calculate.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <footer class="w-full text-center py-8 mt-4 text-slate-500 text-sm">
        <p class="mb-2">Created by <span class="text-indigo-400 font-semibold tracking-wide">Samrudh Shetty</span></p>
        <a href="https://github.com/zynssam" target="_blank" class="inline-flex items-center gap-2 hover:text-white transition-colors duration-300 group">
            <i class="fa-brands fa-github text-lg group-hover:text-indigo-400 transition-colors"></i> 
            <span class="border-b border-transparent group-hover:border-indigo-400">github.com/zynssam</span>
        </a>
    </footer>

    <script>
        // --- LOCAL STORAGE & INIT ---
        function saveInputs() {
            const data = {
                attended: document.getElementById('inputAttended').value,
                total: document.getElementById('inputTotal').value,
                target: document.getElementById('inputTarget').value,
                start: document.getElementById('startDate').value,
                end: document.getElementById('endDate').value,
                holidays: Array.from(holidays),
                schedule: {}
            };
            document.querySelectorAll('.day-input').forEach(i => data.schedule[i.dataset.day] = i.value);
            localStorage.setItem('attCalcData', JSON.stringify(data));
        }

        function loadInputs() {
            const saved = localStorage.getItem('attCalcData');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('inputAttended').value = data.attended || '';
                document.getElementById('inputTotal').value = data.total || '';
                document.getElementById('inputTarget').value = data.target || 75;
                document.getElementById('startDate').value = data.start || moment().format('YYYY-MM-DD');
                document.getElementById('endDate').value = data.end || moment().add(1, 'month').format('YYYY-MM-DD');
                
                if (data.holidays) {
                    holidays = new Set(data.holidays);
                    renderHolidays();
                }
                if (data.schedule) {
                    document.querySelectorAll('.day-input').forEach(i => {
                        if(data.schedule[i.dataset.day]) i.value = data.schedule[i.dataset.day];
                    });
                }
            } else {
                // Defaults
                document.getElementById('startDate').value = moment().format('YYYY-MM-DD');
                document.getElementById('endDate').value = moment().add(1, 'month').format('YYYY-MM-DD');
            }
        }

        // --- APP LOGIC ---
        let holidays = new Set();

        function addHoliday() {
            const input = document.getElementById('holidayInput');
            const dateVal = input.value;
            if (!dateVal) return;
            holidays.add(dateVal);
            renderHolidays();
            input.value = ''; 
            saveInputs();
        }

        function removeHoliday(date) {
            holidays.delete(date);
            renderHolidays();
            saveInputs();
        }

        function clearHolidays() {
            holidays.clear();
            renderHolidays();
            saveInputs();
        }

        function renderHolidays() {
            const list = document.getElementById('holidayList');
            list.innerHTML = '';
            if (holidays.size === 0) {
                list.innerHTML = '<li class="text-xs text-slate-600 text-center italic py-2">No dates excluded</li>';
                return;
            }
            [...holidays].sort().forEach(date => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-slate-700/40 hover:bg-slate-700/60 px-2 py-1.5 rounded border border-white/5 transition-colors';
                li.innerHTML = `<span class="text-xs text-slate-300 font-mono">${moment(date).format('MMM DD (ddd)')}</span><button onclick="removeHoliday('${date}')" class="text-slate-500 hover:text-red-400 px-1"><i class="fa-solid fa-xmark text-xs"></i></button>`;
                list.appendChild(li);
            });
        }

        function calculateAttendance() {
            saveInputs(); 

            const currentAttended = parseInt(document.getElementById('inputAttended').value) || 0;
            const currentTotal = parseInt(document.getElementById('inputTotal').value) || 0;
            const targetPct = parseFloat(document.getElementById('inputTarget').value) || 75;
            const start = moment(document.getElementById('startDate').value);
            const end = moment(document.getElementById('endDate').value);
            
            const weekSchedule = {};
            document.querySelectorAll('.day-input').forEach(i => weekSchedule[i.dataset.day] = parseInt(i.value) || 0);

            const targetDecimal = targetPct / 100;
            let currentPct = (currentAttended / currentTotal * 100);
            if(isNaN(currentPct)) currentPct = 0;

            // 1. SIMULATE FUTURE TO GET TOTAL COUNT
            let simulation = [];
            let totalFutureClasses = 0;
            let loopDate = start.clone();

            // Pre-calculation Loop
            while (loopDate.isSameOrBefore(end)) {
                const dateStr = loopDate.format('YYYY-MM-DD');
                if (!holidays.has(dateStr)) {
                    const classes = weekSchedule[loopDate.day()];
                    if (classes > 0) {
                        totalFutureClasses += classes;
                        simulation.push({
                            date: dateStr, 
                            day: loopDate.format('ddd'), 
                            classes: classes
                        });
                    }
                }
                loopDate.add(1, 'days');
            }

            // 2. CORE MATH: MARGIN OF SAFETY
            // Final Total Classes at end of period = Current + Future
            const finalTotalClasses = currentTotal + totalFutureClasses;
            
            // How many MUST I attend in total to have >= Target% at the end?
            // Formula: ceil(FinalTotal * Target%)
            const requiredTotalAttended = Math.ceil(finalTotalClasses * targetDecimal);
            
            // How many MORE do I need to attend?
            let mustAttendFuture = requiredTotalAttended - currentAttended;
            if (mustAttendFuture < 0) mustAttendFuture = 0; // Already have enough for the end goal

            // How many can I Bunk? (Safe Bunks)
            // Safe Bunks = Total Future Available - Must Attend
            let safeBunks = totalFutureClasses - mustAttendFuture;
            if (safeBunks < 0) safeBunks = 0; // Impossible case

            // 3. IMMEDIATE STATUS (For Banner)
            // "Needed Now" = How many consecutive classes needed to fix CURRENT deficit
            let neededNow = 0;
            if (currentAttended / currentTotal < targetDecimal) {
                const num = (targetDecimal * currentTotal) - currentAttended;
                const den = 1 - targetDecimal;
                neededNow = den <= 0 ? Infinity : Math.ceil(num / den);
            }

            const maxPossiblePct = ((currentAttended + totalFutureClasses) / finalTotalClasses * 100);

            // UPDATE UI
            const statusBanner = document.getElementById('statusBanner');
            const statusTitle = document.getElementById('statusTitle');
            const statusMsg = document.getElementById('statusMessage');
            const statNeeded = document.getElementById('statNeeded');

            statusBanner.classList.remove('hidden', 'border-emerald-500', 'border-amber-500', 'border-red-500');
            statNeeded.className = "text-2xl font-bold text-indigo-300";

            document.getElementById('statCurrent').innerText = currentPct.toFixed(2) + "%";
            document.getElementById('statRemaining').innerText = totalFutureClasses;
            document.getElementById('statMax').innerText = maxPossiblePct.toFixed(2) + "%";
            document.getElementById('statBunks').innerText = safeBunks;

            // Logic Branches
            if (neededNow === 0) {
                // We are currently above target
                statusBanner.classList.add('border-emerald-500');
                statusTitle.innerText = "Target Met! ðŸ¥³";
                statusTitle.className = "text-2xl font-bold mb-1 text-emerald-400";
                statNeeded.innerText = mustAttendFuture; // Show total future requirement

                if (safeBunks > 0) {
                    statusMsg.innerHTML = `You can safely skip <strong class="text-white">${safeBunks}</strong> future classes and still finish with >${targetPct}%.`;
                } else {
                    statusMsg.innerText = `You are safe now, but you must attend ALL ${mustAttendFuture} future classes to maintain it.`;
                }
            } 
            else if (mustAttendFuture <= totalFutureClasses) {
                // We are below target, but it's recoverable
                statusBanner.classList.add('border-amber-500');
                statusTitle.innerText = "Achievable âš ï¸";
                statusTitle.className = "text-2xl font-bold mb-1 text-amber-400";
                statusMsg.innerText = `You need to attend ${mustAttendFuture} of the next ${totalFutureClasses} classes.`;
                statNeeded.innerText = mustAttendFuture;
            } 
            else {
                // Impossible
                statusBanner.classList.add('border-red-500');
                statusTitle.innerText = "Impossible ðŸ›‘";
                statusTitle.className = "text-2xl font-bold mb-1 text-red-400";
                statusMsg.innerText = `Max possible is ${maxPossiblePct.toFixed(2)}%.`;
                statNeeded.innerText = "Imposs.";
                statNeeded.className = "text-2xl font-bold text-red-400";
            }

            // 4. RENDER TABLE
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            let mustAttendCounter = mustAttendFuture;
            let runningAtt = currentAttended;
            let runningTot = currentTotal;

            if(simulation.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-500">No classes in range.</td></tr>';
                return;
            }

            simulation.forEach(day => {
                let rowClass = "hover:bg-slate-800/50 transition-colors";
                let icon = "";
                
                runningTot += day.classes;

                // Logic: If we still have "Must Attend" quota, we assume we attend this day
                // Otherwise, we assume we bunk (to show the lowest safe path) OR just show 100% projection?
                // Standard Practice: Show projection assuming 100% attendance of future events
                runningAtt += day.classes; 
                let projPct = ((runningAtt / runningTot) * 100).toFixed(1);

                // Highlight critical classes
                if (mustAttendCounter > 0) {
                    rowClass = "bg-indigo-900/20 hover:bg-indigo-900/30 border-l-2 border-indigo-500";
                    icon = `<i class="fa-solid fa-circle-exclamation text-indigo-400 mr-2 text-[10px]"></i>`;
                    mustAttendCounter -= day.classes;
                } else {
                    // These are safe to bunk
                     rowClass = "bg-emerald-900/10 hover:bg-emerald-900/20 border-l-2 border-emerald-500/50";
                     icon = `<i class="fa-solid fa-check text-emerald-500 mr-2 text-[10px]"></i>`;
                }

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="py-3 pl-2 text-slate-200">${icon}${moment(day.date).format('MMM DD')}</td>
                    <td class="py-3 text-slate-500 text-xs uppercase tracking-wide">${day.day}</td>
                    <td class="py-3 text-center font-mono text-indigo-300 font-bold">${day.classes}</td>
                    <td class="py-3 text-right pr-2 font-mono text-slate-400">${projPct}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Init
        loadInputs();
        document.querySelectorAll('.save-input').forEach(el => el.addEventListener('change', saveInputs));
    </script>
</body>
</html>
